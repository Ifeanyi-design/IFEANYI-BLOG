{% import "bootstrap/wtf.html" as wtf %}
{% include "header.html" %}

  <!-- Page Header -->
  <header class="masthead" style="background-image: url('{{post.img_url}}')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>{{post.title}}</h1>
            <h2 class="subheading">{{post.subtitle}}</h2>
            <span class="meta">Posted by
              <a href="#">{{post.author.name}}</a>
              on {{post.date}}</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Post Content -->
  <article>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            {{ post.body|safe }}
          <hr>
          {%if current_user.is_authenticated and current_user.id == 1%}
            <div class="clearfix">
            <a class="btn btn-primary float-right" href="{{url_for('edit_post', post_id=post.id)}}">Edit Post</a>
            </div>
          {%endif%}



<!--           Comments Area -->
          <hr>
          <div>
            {{ ckeditor.load() }}
            {{ ckeditor.config(name="comment") }}
            {{ wtf.quick_form(form, id="commentForm", action=url_for('add_comment', post_id=post.id), novalidate=true, button_map={"submit": "primary"}) }}
          </div>
          <div id="comments-container" class="col-lg-8 col-md-10 mx-auto comment">
  {% for comment in post.post_comments %}
    <ul class="commentList">
      <li>
          <div class="commenterImage">
            <img src="{{gravatar_url(comment.comment_author.email)}}"/>
          </div>
          <div class="commentText">
            <p>{{comment.comment | safe}}</p>
            <span class="date sub-text">{{comment.comment_author.name}}</span>
          </div>
      </li>
    </ul>
  {% endfor %}
</div>


          </div>
      </div>
    </div>
  </article>

<script>

document.getElementById("commentForm").addEventListener("submit", async function(event) {
    event.preventDefault();

    // Make sure CKEditor updates textarea
    for (let instance in CKEDITOR.instances) {
        CKEDITOR.instances[instance].updateElement();
    }

    const form = event.target;
    const formData = new FormData(form);
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch(form.action, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": csrfToken
            }
        });

        const data = await response.json();

        if (data.success) {
            const newComment = document.createElement("ul");
            newComment.classList.add("commentList");
            newComment.innerHTML = `
                <li>
                    <div class="commenterImage">
                      <img src="${data.comment.gravatar}"/>
                    </div>
                    <div class="commentText">
                      <p>${data.comment.text}</p>
                      <span class="date sub-text">${data.comment.author}</span>
                    </div>
                </li>
            `;
            document.getElementById("comments-container").prepend(newComment);
            CKEDITOR.instances['comment'].setData('');
        } else if (data.errors) {
            console.log("Validation errors:", data.errors);
            alert("Please fill in the comment field.");
        } else {
            alert(data.error || "Something went wrong");
        }
    } catch (err) {
        console.error(err);
        alert("Error submitting comment");
    }
});
</script>

  <hr>
{% include "footer.html" %}